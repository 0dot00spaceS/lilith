git = new Git()

class Git {
	def getHeadHash() {
		File f=new File('.');
		File gitHome;
		while(f)
		{
			f=f.absoluteFile
			gitHome=new File(f, '.git');
			if(gitHome.directory)
			{
				break;
			}
			f=f.parentFile
		}
		if(!gitHome)
		{
			return null
		}
		
		final REF_PREFIX='ref: ';
		try
		{
			String line;
			new File(gitHome, 'HEAD').withReader{
				r -> line=r.readLine()
			}
			
			if(!line || !line.startsWith(REF_PREFIX))
			{
				return null;
			}
			
			new File(gitHome, line.substring(REF_PREFIX.length())).withReader{
				r -> line=r.readLine()
			}
			return line
		}
		catch(IOException ex)
		{
			return null
		}
	}
}


